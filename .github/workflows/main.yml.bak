# Job to create server cache in the master branch that will be available to all braches that are based on master branch

name: CI-contest-viewer

#Environment variables!
env:
  AWS_S3_BUCKET : contest-viewer
  AWS_REGION    : us-east-1

permissions:
      id-token: write   # This is required for requesting the JWT
      contents: read    # This is required for actions/checkout

# Workflow will run on push to master
on:
  push:
    branches: [ "master" ]

# A workflow run is made up of build and deploy job
jobs:
#Server folder build job (runs concurrently with client build job)
  build_server:
  # The type of runner that the job will run on
    runs-on: ubuntu-22.04
    defaults:
      run:
      # Server folder working directory.
        working-directory: server 

      # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository
    - name: Git clone
      uses: actions/checkout@v3
      
    - uses: dorny/paths-filter@v2
      id: filter
      with:
        filters: |
          server:
            - 'server/**'     
            
    - name: Cache ~/cache
      if: steps.filter.outputs.server == 'true'
      uses: actions/cache@v3
      id:   cache-stack
      with:
        path: server/cache
        key: ${{ runner.os }}-stack-global-${{ hashFiles('server/stack.yaml') }}-${{ hashFiles('server/package.yaml') }}
        
    - if: steps.filter.outputs.server == 'true'
      run: |
        # Build backend-artifacts
        docker build -f Dockerfile.artifacts -t artifacts .
        # Create container from image without running it to extract artifacts
        id=$(docker create artifacts)
        # Save stack depenencies cache
        # to avoid copying the same archive to the host again (useful only for frequent local docker builds)
        docker cp $id:/root/stack_dependencies_cache.tar.gz - >./cache/stack_dependencies_cache.tar.gz.tar
        
    - name: Configure AWS credentials
      if: steps.filter.outputs.server == 'true'
      uses: aws-actions/configure-aws-credentials@v1
      with:
        role-to-assume: arn:aws:iam::861421774830:role/contest-viewer_ECS_access
        role-session-name: server_push
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      if: steps.filter.outputs.server == 'true'
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v1

    - name: Build, tag, and push image to Amazon ECR
      if: steps.filter.outputs.server == 'true'
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        ECR_REPOSITORY: contest-viewer_server
        IMAGE_TAG: ${{ github.sha }}
      run: |
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

#client folder build job (runs concurrently with server build job)
  build_client:
  # The type of runner that the job will run on
    runs-on: ubuntu-22.04
    defaults:
      run:
      # Server folder working directory.
        working-directory: client 

      # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository
    - name: Git clone
      uses: actions/checkout@v3
      
    - uses: dorny/paths-filter@v2
      id: filter
      with:
        filters: |
          client:
            - 'client/**'     
      
    - name: Configure AWS credentials
      if: steps.filter.outputs.client == 'true'
      uses: aws-actions/configure-aws-credentials@v1
      with:
        role-to-assume: arn:aws:iam::861421774830:role/contest-viewer_ECS_access
        role-session-name: client_push
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      if: steps.filter.outputs.client == 'true'
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v1

    - name: Build, tag, and push image to Amazon ECR
      if: steps.filter.outputs.client == 'true'
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        ECR_REPOSITORY: contest-viewer_client
        IMAGE_TAG: ${{ github.sha }}
      run: |
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

        
